PREFIX qb: <http://purl.org/linked-data/cube#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX csvw: <http://www.w3.org/ns/csvw#>

SELECT ?csvColumnPropertyUrl (GROUP_CONCAT(?observationValueColumnTitle; separator=', ') as ?observationValueColumnTitles)
WHERE 
{
    ?tableSchema csvw:column/rdf:rest*/rdf:first ?csvColumn.

    OPTIONAL {
        ?csvColumn csvw:aboutUrl ?csvColumnAboutUrl;
                    csvw:propertyUrl ?csvColumnPropertyUrl.


        ?tableSchema csvw:column/rdf:rest*/rdf:first ?observedValueColumn.
        FILTER NOT EXISTS {
            ?observedValueColumn csvw:virtual true.
        }

        # The obs val column for this column is the one matching on the aboutUrl with a 
        # valid measureUri in the propertyUrl field.
        ?observedValueColumn csvw:aboutUrl ?csvColumnAboutUrl;
                            csvw:propertyUrl ?observedValueColPropertyUrl;
                            csvw:title ?observationValueColumnTitle.

        FILTER EXISTS {
            ?dsd_uri a qb:DataStructureDefinition;
                    # Get list of possible measures in this DSD
                    qb:component/qb:measure ?measureUri.
            FILTER (strends(str(?observedValueColPropertyUrl), str(?measureUri)) || strends(str(?measureUri), str(?observedValueColPropertyUrl))).
        }                       
    }
    FILTER(STRLEN(str(?observedValueColPropertyUrl)) > 0)                    
}
GROUP BY ?csvColumnPropertyUrl