# Stress Testing

## Intro
To stress test csvcubed, we use a tool called JMeter to run two separate test plans for the build command and inspect command respectively.  
The test plans are run consecutively via a bash script and follow broadly the same structure:

- Start running a performance monitor in the background
- Generate a "maximally complex" CSV file with the number of rows the user has given as a parameter to the bash script.
  1. This is a preprocess which is a groovy script which in turn runs a python script because JMeter will not execute `.py` files.
      - The inspect command test then runs the build command on this CSV file so that the json-ld output generated by the build command can be used as the input to the inspect command.
- Run the test's designated command 5 times using the results of the preprocess step above as inputs.
  1. The performance monitor records CPU and Memory usage throughout the duration of the test's 5 runs.
- A postprocess removes any unwanted resultant files.
  1. Also a groovy script which in turn runs a python script.
- Steps 2 - 4 are repeated for the second command
- The performance monitor is terminated.
- Finally, metrics files are cleaned up and placed into relevant folders.

## Installation Guide
- Install JMeter: https://jmeter.apache.org/download_jmeter.cgi
  1. Choose either of the binaries to download
  2. Once extracted in a location of your choosing, navigate to the `/bin` folder
      - Add this full path to the `/bin` folder to your system's path variables
      - Once added, reload your terminal for the changes to be recognised
    
- Install a Java DK: https://www.oracle.com/java/technologies/downloads/
  1. JMeter requires any JDK version 8+ but the latest is recommended
  
- Install the JMeter Plugins Manager: https://jmeter-plugins.org/wiki/PluginsManager/
  1 Place the downloaded file into JMeter's `lib/ext` directory

- Install the PerfMon Server Agent: https://github.com/undera/perfmon-agent
  1. Unzip to a location of your choosing
  2. Once extracted, add the path to the ServerAgent directory to your system's path variables
  3. Once added, reload your terminal for the changes to be recognised

- Install the PerfMon plugin for JMeter
  1. Open JMeter in GUI mode by opening a terminal and running > `jmeter.sh`
  2. It may take a few seconds before the window opens
  3. If nothing happens or there is an error, ensure you have correctly installed JMeter and added the location of JMeter's `/bin` folder to your path variables
  4. Once in JMeter go to `Options > Plugins Manager`
  5. In the new window, select the "Available" tab and look for `"PerfMon (Servers Performance Monitoring)"` in the list of plugins
  6. Tick the box for this plugin and select `Apply All Changes and Restart`
  7. Once restarted you can close the JMeter GUI window
  
## Running the Tests
- Open a terminal
- Navigate to `csvcubed/tests/stress`
- Run > `./stresstest.sh x`
  1. Where `x` represents the number of rows you wish to use in stress testing. E.g. > `./stresstest.sh 10000`
- When run, you should see:
  1. Some startup information from the PerfMon Server Agent
  2. Information as the first test is running - this may take some time to complete depending on the number of rows used in the test 
      - This will repeat for the second test and take a very similar appearance directly underneath
  3. Finally, upon completion, some key metrics from each test are printed to the terminal
      - Your times may differ
      - This will also repeat for the results of the inspect command test and prints directly below  

**Note** - The tests can be run using the JMeter GUI, however this is not recommended when trying to record accurate stress testing results.
if you wish to run the tests using the GUI (probably for debugging changes to the JMeter test plans):

- Open JMeter in GUI mode by opening a terminal and running > `jmeter.sh`
- Open the test plan you wish to run. E.g. `buildcommandtest.jmx` or `inspectcommandtest.jmx`
- Press the green play button in the top bar to start the test
- When debugging, it can be useful to:
  1. Open the live logs by clicking on the exclamation mark in a yellow triangle in the upper right corner
      - You can clear the logs by clicking the cog+broom button in the top bar
  2. Add a `View Results Tree` listener to the test plan
      - Right click on test plan in the top left of the sidebar
      - Hover over `> Add > Listeners > View Results Tree`

By default, tests run in GUI mode will use CSVs containing 10 rows. If you need to change this, you must do so manually
Open the groovy file associated with the test's preprocess. E.g. `buildpreprocess.groovy` or `inspectpreprocess.groovy`
Change the default value defined in `line 26`

When you are finished using JMeter in GUI mode, please make sure you remove any results tree listeners which were added as they may have an effect on
performance during Non-GUI mode execution.

## Results
As well as printing times, maximum and average values to the terminal, each run of the stress tests will generate a new folder in the csvcubed/tests/stress/metrics directory
marked by the timestamp from when the test was initiated. Inside this folder there will be 3 files:

- Buildmetrics-timestamp.csv
- Inspectmetrics-timestamp.csv
- jmeter.log
    1. Where timestamp is replaced by the time at which the first metric was recorded for that particular test  

The two .CSV files contain metric values and the times at which they were recorded for each test and should be the starting point for deeper analysis.  

The jmeter.log file contains the logs from the last test plan to be executed. This should be the inspectcommand.jmx script unless something went wrong during execution 
of the buildcommand.jmx script.

 

